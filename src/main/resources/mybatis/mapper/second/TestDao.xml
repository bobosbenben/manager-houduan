<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duobi.manager.sys.testDao.TestDao">
	<!--<cache type="org.mybatis.caches.ehcache.EhcacheCache" />-->
	<!--<cache></cache>-->

	<resultMap id="roleResult" type="com.duobi.manager.sys.entity.Role">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="enname" column="enname" />
		<result property="roleType" column="roleType" />
		<result property="dataScope" column="dataScope" />
		<result property="remarks" column="remarks" />
		<result property="useable" column="useable" />
		<result property="sysData" column="sysData" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<association property="module" javaType="com.duobi.manager.sys.entity.Menu">
			<id property="id" column="module_id" />
			<result property="name" column="module_name" />
			<result property="type" column="module_type" />
		</association>
		<collection property="menuList" ofType="com.duobi.manager.sys.entity.Menu">
			<id property="id" column="menuList.id" />
		</collection>
		<collection property="organizationList" ofType="com.duobi.manager.sys.entity.Organization">
			<id property="id" column="organizationList.id" />
		</collection>
	</resultMap>

	<sql id="roleColumns">
		a.id,
		a.module_id AS "module_id",
		a.name,
		a.enname,
		a.role_type AS roleType,
		a.data_scope AS dataScope,
		a.remarks,
		a.create_by AS "createBy.id",
		a.create_time,
		a.update_by AS "updateBy.id",
		a.update_time,
		a.del_flag,
		m.name AS "module_name",
		m.type AS "module_type",
		a.useable AS useable,
		a.is_sys AS sysData
	</sql>

	<sql id="roleJoins">
		LEFT JOIN t_sys_menu m ON m.id = a.module_id
		LEFT JOIN t_sys_role_menu rm ON rm.role_id = a.id
		LEFT JOIN t_sys_role_organization ro ON ro.role_id = a.id
	</sql>

	<select id="getRoleById" resultMap="roleResult">
		SELECT
		<include refid="roleColumns"/>,
		rm.menu_id AS "menuList.id",
		ro.organization_id AS "organizationList.id"
		FROM t_sys_role a
		<include refid="roleJoins" />
		WHERE a.id = #{id} AND a.del_flag = #{DEL_FLAG_NORMAL}
	</select>

	<insert id="insert">
		<selectKey resultType="java.lang.Long"  order="AFTER" keyProperty="id" >
			SELECT currval('t_sys_role_id_seq') AS id
		</selectKey>

		INSERT INTO t_sys_role(
		module_id,
		name,
		enname,
		role_type,
		data_scope,
		create_by,
		create_time,
		update_by,
		update_time,
		remarks,
		del_flag,
		is_sys,
		useable
		) VALUES (
		#{module.id},
		#{name},
		#{enname},
		#{roleType},
		#{dataScope},
		#{createBy.id},
		#{createTime},
		#{updateBy.id},
		#{updateTime},
		#{remarks},
		#{delFlag},
		#{sysData},
		#{useable}
		)
	</insert>
	
</mapper>